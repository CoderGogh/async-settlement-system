<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>메시지 발송 현황 | 관리자</title>
    <link rel="stylesheet" th:href="@{/css/message-dashboard.css}">
</head>

<body>
<div class="container">
    <h1>메시지 발송 현황</h1>
    <div class="subtitle">
        정산 배치 · 메시지 발송 시스템 관리자 페이지
    </div>

    <div class="card">
        <!-- 정산월 -->
        <div class="month">
            정산월: <span id="settlementMonth" th:text="${summary.settlementMonth}">2026-01</span>
        </div>

        <div class="total">
            총 발송 메시지 <span id="totalCount" th:text="${summary.totalCount}">0</span>건
        </div>

        <!-- 이메일 WAITED -->
        <div class="section">
            <div class="section-title">
                <span>이메일 발송 대기 건</span>
                <span class="rate">
                    <span id="waitCount" th:text="${summary.waitCount}">0</span>건
                    · <span id="waitRate" th:text="${#numbers.formatDecimal(summary.waitRate,1,2)}">0</span>%
                </span>
            </div>
            <div class="bar-wrap">
                <div id="waitBar" class="bar wait" th:style="'width:' + ${summary.waitRate} + '%'"></div>
            </div>
        </div>

        <!-- 이메일 SENT -->
        <div class="section">
            <div class="section-title">
                <span>이메일 발송 성공 건</span>
                <span class="rate">
                    <span id="sentCount" th:text="${summary.sentCount}">0</span>건
                    · <span id="sentRate" th:text="${#numbers.formatDecimal(summary.sentRate,1,2)}">0</span>%
                </span>
            </div>
            <div class="bar-wrap">
                <div id="sentBar" class="bar sent" th:style="'width:' + ${summary.sentRate} + '%'"></div>
            </div>
        </div>

        <!-- 이메일 RETRY -->
        <div class="section">
            <div class="section-title">
                <span>이메일 재발송 대기 건</span>
                <span class="rate">
                    <span id="retryCount" th:text="${summary.retryCount}">0</span>건
                    · <span id="retryRate" th:text="${#numbers.formatDecimal(summary.retryRate,1,2)}">0</span>%
                </span>
            </div>
            <div class="bar-wrap">
                <div id="retryBar" class="bar retry" th:style="'width:' + ${summary.retryRate} + '%'"></div>
            </div>
        </div>

       <!-- SMS -->
		<div class="section">
		    <div class="section-title">
		        <span>SMS 발송 건</span>
		        <span class="rate">
		            <span id="smsCount" th:text="${summary.smsCount}">0</span>건
		            · <span id="smsRate" th:text="${#numbers.formatDecimal(summary.smsRate,1,2)}">0</span>%
		        </span>
		    </div>
		    <div class="bar-wrap">
		        <div id="smsBar" class="bar sms" th:style="'width:' + ${summary.smsRate} + '%'"></div>
		    </div>
		</div>


        <!-- FAIL -->
        <div class="section">
            <div class="section-title">
                <span>메시지 발송 실패 건</span>
                <span class="rate">
                    <span id="failCount" th:text="${summary.failCount}">0</span>건
                    · <span id="failRate" th:text="${#numbers.formatDecimal(summary.failRate,1,2)}">0</span>%
                </span>
            </div>
            <div class="bar-wrap">
                <div id="failBar" class="bar fail" th:style="'width:' + ${summary.failRate} + '%'"></div>
            </div>
        </div>
    </div>

    <div class="footer">
        실시간 갱신 · 2초 주기
    </div>
</div>

<script>
const eventSource = new EventSource('/admin/message/stream');

eventSource.onmessage = function(event) {
    try {
        const data = JSON.parse(event.data);

        // 정산월 / 총 발송
        const settlementMonthEl = document.getElementById('settlementMonth');
        if (settlementMonthEl) settlementMonthEl.innerText = data.settlementMonth || '';
        const totalCountEl = document.getElementById('totalCount');
        if (totalCountEl) totalCountEl.innerText = data.totalCount || 0;

        // 이메일 WAITED
        const waitCountEl = document.getElementById('waitCount');
        if (waitCountEl) waitCountEl.innerText = data.waitCount || 0;
        const waitRateEl = document.getElementById('waitRate');
        if (waitRateEl) waitRateEl.innerText = (data.waitRate || 0).toFixed(2);
        const waitBarEl = document.getElementById('waitBar');
        if (waitBarEl) waitBarEl.style.width = (data.waitRate || 0) + '%';

        // 이메일 SENT
        const sentCountEl = document.getElementById('sentCount');
        if (sentCountEl) sentCountEl.innerText = data.sentCount || 0;
        const sentRateEl = document.getElementById('sentRate');
        if (sentRateEl) sentRateEl.innerText = (data.sentRate || 0).toFixed(2);
        const sentBarEl = document.getElementById('sentBar');
        if (sentBarEl) sentBarEl.style.width = (data.sentRate || 0) + '%';

        // 이메일 RETRY
        const retryCountEl = document.getElementById('retryCount');
        if (retryCountEl) retryCountEl.innerText = data.retryCount || 0;
        const retryRateEl = document.getElementById('retryRate');
        if (retryRateEl) retryRateEl.innerText = (data.retryRate || 0).toFixed(2);
        const retryBarEl = document.getElementById('retryBar');
        if (retryBarEl) retryBarEl.style.width = (data.retryRate || 0) + '%';

		// SMS
		const smsCountEl = document.getElementById('smsCount');
		if (smsCountEl) smsCountEl.innerText = data.smsCount || 0;
		const smsRateEl = document.getElementById('smsRate');
		if (smsRateEl) smsRateEl.innerText = (data.smsRate || 0).toFixed(2);
		const smsBarEl = document.getElementById('smsBar');
		if (smsBarEl) smsBarEl.style.width = (data.smsRate || 0) + '%';

        // FAIL
        const failCountEl = document.getElementById('failCount');
        if (failCountEl) failCountEl.innerText = data.failCount || 0;
        const failRateEl = document.getElementById('failRate');
        if (failRateEl) failRateEl.innerText = (data.failRate || 0).toFixed(2);
        const failBarEl = document.getElementById('failBar');
        if (failBarEl) failBarEl.style.width = (data.failRate || 0) + '%';

    } catch (e) {
        console.error("SSE 업데이트 오류:", e);
    }
};

eventSource.onerror = function(err) {
    console.error("SSE 연결 오류:", err);
};
</script>
</body>
</html>
