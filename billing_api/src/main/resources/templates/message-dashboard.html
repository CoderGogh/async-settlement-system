<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>메시지 발송 현황 | 관리자</title>
    <link rel="stylesheet" th:href="@{/css/message-dashboard.css}">
</head>

<body>
<div class="container">
    <h1>메시지 발송 현황</h1>
    <div class="subtitle">
        정산 배치 · 메시지 발송 시스템 관리자 페이지
    </div>

    <div class="card">
        <!-- 이번 정산월 표시 -->
        <div class="month">
            정산월: <span id="settlementMonth" th:text="${summary.settlementMonth}">2026-01</span>
        </div>

        <div class="total">
            총 발송 메시지 <span id="totalCount" th:text="${summary.totalCount}">0</span>건
        </div>

        <!-- WAITED -->
        <div class="section">
            <div class="section-title">
                <span>메시지 발송 대기 건</span>
                <span class="rate">
                    <span id="waitCount" th:text="${summary.waitCount}">0</span>건
                    · <span id="waitRate" th:text="${#numbers.formatDecimal(summary.waitRate,1,2)}">0</span>%
                </span>
            </div>
            <div class="bar-wrap">
                <div id="waitBar" class="bar wait" th:style="'width:' + ${summary.waitRate} + '%'"></div>
            </div>
        </div>

        <!-- SENT -->
        <div class="section">
            <div class="section-title">
                <span>메시지 발송 성공 건</span>
                <span class="rate">
                    <span id="sentCount" th:text="${summary.sentCount}">0</span>건
                    · <span id="sentRate" th:text="${#numbers.formatDecimal(summary.sentRate,1,2)}">0</span>%
                </span>
            </div>
            <div class="bar-wrap">
                <div id="sentBar" class="bar sent" th:style="'width:' + ${summary.sentRate} + '%'"></div>
            </div>
        </div>

        <!-- RETRY -->
        <div class="section">
            <div class="section-title">
                <span>재발송 대기 건</span>
                <span class="rate">
                    <span id="retryCount" th:text="${summary.retryCount}">0</span>건
                    · <span id="retryRate" th:text="${#numbers.formatDecimal(summary.retryRate,1,2)}">0</span>%
                </span>
            </div>
            <div class="bar-wrap">
                <div id="retryBar" class="bar retry" th:style="'width:' + ${summary.retryRate} + '%'"></div>
            </div>
        </div>

        <!-- FAIL -->
        <div class="section">
            <div class="section-title">
                <span>메시지 발송 실패 건</span>
                <span class="rate">
                    <span id="failCount" th:text="${summary.failCount}">0</span>건
                    · <span id="failRate" th:text="${#numbers.formatDecimal(summary.failRate,1,2)}">0</span>%
                </span>
            </div>
            <div class="bar-wrap">
                <div id="failBar" class="bar fail" th:style="'width:' + ${summary.failRate} + '%'"></div>
            </div>
        </div>
    </div>

    <div class="footer">
        실시간 갱신 · 2초 주기
    </div>
</div>

<script>
const eventSource = new EventSource('/admin/message/stream');

eventSource.onmessage = function (event) {
    try {
        const data = JSON.parse(event.data);

        document.getElementById('settlementMonth')?.innerText = data.settlementMonth || '';
        document.getElementById('totalCount')?.innerText = data.totalCount || 0;

        document.getElementById('waitCount')?.innerText = data.waitCount || 0;
        document.getElementById('waitRate')?.innerText = (data.waitRate || 0).toFixed(1);
        document.getElementById('waitBar')?.style.width = (data.waitRate || 0) + '%';

        document.getElementById('sentCount')?.innerText = data.sentCount || 0;
        document.getElementById('sentRate')?.innerText = (data.sentRate || 0).toFixed(1);
        document.getElementById('sentBar')?.style.width = (data.sentRate || 0) + '%';

        document.getElementById('retryCount')?.innerText = data.retryCount || 0;
        document.getElementById('retryRate')?.innerText = (data.retryRate || 0).toFixed(1);
        document.getElementById('retryBar')?.style.width = (data.retryRate || 0) + '%';

        document.getElementById('failCount')?.innerText = data.failCount || 0;
        document.getElementById('failRate')?.innerText = (data.failRate || 0).toFixed(1);
        document.getElementById('failBar')?.style.width = (data.failRate || 0) + '%';

    } catch (e) {
        console.error("SSE 업데이트 오류:", e);
    }
};

eventSource.onerror = function(err) {
    console.error("SSE 연결 오류:", err);
};
</script>

</body>
</html>
