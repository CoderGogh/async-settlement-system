<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>정산 · 메시지 대시보드</title>
    <link rel="stylesheet" th:href="@{/css/whole-process-dashboard.css}">
</head>
<body>
<div class="container">
    <h1>정산 · 메시지 대시보드</h1>

    <!-- ================= 총 데이터 ================= -->
    <div class="card">
        <div class="step-row">
            <span class="step-name">
                총 데이터
                <small>
                    <span th:text="${summary?.totalCount ?: 0}">0</span>건
                </small>
            </span>
        </div>
    </div>

    <!-- ================= 배치 프로세스 ================= -->
    <div class="card">
        <!-- Batch Job -->
        <div class="step-row">
            <span class="step-name">
                Batch Job 진행 상태
                <small>
                    ( <span th:text="${summary?.batchCount ?: 0}">0</span>
                    / <span th:text="${summary?.totalCount ?: 0}">0</span> )
                    · <span th:text="${#numbers.formatDecimal(summary?.batchRate ?: 0,1,2)}">0</span>%
                </small>
            </span>
            <span id="batchJob" class="status waited"></span>
        </div>
        <div class="bar-wrap">
            <div id="bar-batchJob"
                 class="bar wait"
                 th:style="'width:' + (${summary?.batchRate ?: 0}) + '%'">
            </div>
        </div>

        <!-- Kafka Sent -->
        <div class="step-row">
            <span class="step-name">
                Kafka Sent 진행 상태
                <small>
                    ( <span th:text="${summary?.kafkaSentCount ?: 0}">0</span>
                    / <span th:text="${summary?.totalCount ?: 0}">0</span> )
                    · <span th:text="${#numbers.formatDecimal(summary?.kafkaSentRate ?: 0,1,2)}">0</span>%
                </small>
            </span>
            <span id="batchKafkaSent" class="status waited"></span>
        </div>
        <div class="bar-wrap">
            <div id="bar-batchKafkaSent"
                 class="bar wait"
                 th:style="'width:' + (${summary?.kafkaSentRate ?: 0}) + '%'">
            </div>
        </div>
    </div>

    <!-- ================= 메시지 프로세스 ================= -->
    <div class="card">
        <!-- Kafka Receive -->
        <div class="step-row">
            <span class="step-name">
                Kafka Receive 진행 상태
                <small>
                    ( <span th:text="${summary?.kafkaReceiveCount ?: 0}">0</span>
                    / <span th:text="${summary?.totalCount ?: 0}">0</span> )
                    · <span th:text="${#numbers.formatDecimal(summary?.kafkaReceiveRate ?: 0,1,2)}">0</span>%
                </small>
            </span>
            <span id="messageKafkaReceive"
                  class="status"
                  th:text="${message?.kafkaReceive?.label ?: '대기'}"
                  th:classappend="${message?.kafkaReceive?.name()?.toLowerCase()}">
            </span>
        </div>
        <div class="bar-wrap">
            <div id="bar-messageKafkaReceive"
                 class="bar wait"
                 th:style="'width:' + (${summary?.kafkaReceiveRate ?: 0}) + '%'">
            </div>
        </div>

        <!-- Create Message -->
        <div class="step-row">
            <span class="step-name">
                Create Message 진행 상태
                <small>
                    ( <span th:text="${summary?.createMessageCount ?: 0}">0</span>
                    / <span th:text="${summary?.totalCount ?: 0}">0</span> )
                    · <span th:text="${#numbers.formatDecimal(summary?.createMessageRate ?: 0,1,2)}">0</span>%
                </small>
            </span>
            <span id="messageCreateMessage"
                  class="status"
                  th:text="${message?.createMessage?.label ?: '대기'}"
                  th:classappend="${message?.createMessage?.name()?.toLowerCase()}">
            </span>
        </div>
        <div class="bar-wrap">
            <div id="bar-messageCreateMessage"
                 class="bar wait"
                 th:style="'width:' + (${summary?.createMessageRate ?: 0}) + '%'">
            </div>
        </div>

        <!-- Sent Message -->
        <div class="step-row">
            <span class="step-name">
                Sent Message 진행 상태
                <small>
                    ( <span th:text="${summary?.sentMessageCount ?: 0}">0</span>
                    / <span th:text="${summary?.totalCount ?: 0}">0</span> )
                    · <span th:text="${#numbers.formatDecimal(summary?.sentMessageRate ?: 0,1,2)}">0</span>%
                </small>
            </span>
            <span id="messageSentMessage"
                  class="status"
                  th:text="${message?.sentMessage?.label ?: '대기'}"
                  th:classappend="${message?.sentMessage?.name()?.toLowerCase()}">
            </span>
        </div>
        <div class="bar-wrap">
            <div id="bar-messageSentMessage"
                 class="bar wait"
                 th:style="'width:' + (${summary?.sentMessageRate ?: 0}) + '%'">
            </div>
        </div>
    </div>
</div>

<script>
/* ================= 상태 한글 매핑 ================= */
const STATUS_LABEL = {
    WAITED: '대기',
    PENDING: '진행 중',
    DONE: '완료',
    FAIL: '실패'
};

/* ================= 상태 업데이트 ================= */
function updateStatus(id, status) {
    const el = document.getElementById(id);
    if (!el || !status) return;

    el.textContent = STATUS_LABEL[status] ?? status;
    el.classList.remove('waited', 'pending', 'done', 'fail');
    el.classList.add(status.toLowerCase());
}

/* ================= 진행률 바 업데이트 ================= */
function updateBar(barId, rate) {
    const bar = document.getElementById(barId);
    if (!bar) return;

    const value = Math.max(0, Math.min(rate ?? 0, 100));
    bar.style.width = value + '%';

    bar.classList.remove('wait', 'pending', 'done', 'fail');

    if (value === 0) {
        bar.classList.add('wait');
    } else if (value < 100) {
        bar.classList.add('pending');
    } else {
        bar.classList.add('done');
    }
}

/* ================= 초기 로딩 ================= */
function initProgressBars() {
    document.querySelectorAll('.bar').forEach(bar => {
        const rate = parseFloat(bar.style.width) || 0;
        updateBar(bar.id, rate);
    });
}

/* ================= SSE ================= */
const eventSource = new EventSource('/admin/process/stream');

eventSource.onmessage = function(event) {
    try {
        const data = JSON.parse(event.data);

        updateStatus('batchJob', data.batchJob);
        updateStatus('batchKafkaSent', data.batchKafkaSent);
        updateStatus('messageKafkaReceive', data.messageKafkaReceive);
        updateStatus('messageCreateMessage', data.messageCreateMessage);
        updateStatus('messageSentMessage', data.messageSentMessage);

        updateBar('bar-batchJob', data.batchRate);
        updateBar('bar-batchKafkaSent', data.kafkaSentRate);
        updateBar('bar-messageKafkaReceive', data.kafkaReceiveRate);
        updateBar('bar-messageCreateMessage', data.createMessageRate);
        updateBar('bar-messageSentMessage', data.sentMessageRate);

    } catch (e) {
        console.error('SSE 업데이트 오류:', e);
    }
};

eventSource.onerror = function(err) {
    console.error('SSE 연결 오류:', err);
};

/* ================= 최초 실행 ================= */
document.addEventListener('DOMContentLoaded', initProgressBars);
</script>

</body>
</html>
