<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Billing Tower</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/message-dashboard.css}">
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <style>
        .progress { height: 28px; border-radius: 15px; background-color: #dee2e6; }
        .monitor-card { transition: all 0.3s ease; border: none; }
        .inactive-monitor { filter: grayscale(100%); opacity: 0.65; background-color: #f8f9fa; }
        .status-dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .dot-online { background-color: #28a745; box-shadow: 0 0 10px #28a745; animation: blink 1.5s infinite; }
        .dot-offline { background-color: #adb5bd; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        .metric-card { background: white; border: 1px solid #eee; padding: 15px; border-radius: 10px; transition: 0.3s; }
        .clickable-error { cursor: pointer; border: 2px solid #dc3545 !important; background-color: #fff5f5; }
        .clickable-error:hover { transform: scale(1.02); box-shadow: 0 4px 15px rgba(220, 53, 69, 0.2); }
        .progress-bar {
            transition: width 0.1s linear;
        }
        #statusText {
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="bg-light">
<div th:replace="~{layout/sidebar :: sidebar}"></div>
<div class="container py-5">
    <h2 class="mb-4 fw-bold text-dark border-bottom pb-3">배치 모니터링</h2>

    <div id="liveArea" class="card shadow monitor-card mb-5 inactive-monitor">
        <div class="card-header bg-secondary text-white py-3" id="liveHeader">
            <h5 class="mb-0 d-flex align-items-center">
                <span id="statusDot" class="status-dot dot-offline"></span>
                <span id="statusText">연결 대기 중...</span>
                <small class="ms-auto text-light" id="lastSuccessInfo"
                       th:if="${lastSuccess != null}"
                       th:text="'최종 성공: #' + ${lastSuccess.JOB_EXECUTION_ID} + ' (' + ${lastSuccess.END_TIME} + ')'"></small>
            </h5>
        </div>
        <div class="card-body p-4">
            <div class="row align-items-center mb-4">
                <div class="col-md-9">
                    <div class="progress shadow-sm">
                        <div id="progressBar" class="progress-bar bg-secondary" role="progressbar" style="width: 0%">0%</div>
                    </div>
                </div>
                <div class="col-md-3 text-end text-muted fw-bold">
                    <span id="processedCount">0</span> / 1,000,000
                </div>
            </div>
            <div class="row g-3 text-center">
                <div class="col-md-4"><div class="metric-card shadow-sm">TPS: <span class="fw-bold h4 text-primary" id="tpsValue">0.0</span></div></div>
                <div class="col-md-4"><div class="metric-card shadow-sm text-success">ETC: <span class="fw-bold h4" id="etcValue">00:00:00</span></div></div>
                <div class="col-md-4"><div id="skipCard" class="metric-card shadow-sm">Skip: <span class="fw-bold h4 text-danger" id="skipCount">0</span></div></div>
            </div>
            <div id="partitionGrid" class="row g-2 mt-4 text-center text-muted small">작업 대기 중...</div>
        </div>
    </div>

    <div id="historyTableContainer" th:fragment="history-table-content" class="card shadow-sm border-0">
        <div class="card-header bg-white py-3">최근 배치 실행 이력</div>
        <table class="table table-hover mb-0 text-center">
            <thead class="table-light text-secondary small">
            <tr>
                <th>ID</th><th>상태</th><th>시작 시간</th><th>처리 건수</th><th>소요 시간</th><th>스킵 건수</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="h : ${historyList}">
                <td th:text="${h.executionId}" class="fw-bold text-primary"></td>
                <td><span th:text="${h.status}" th:classappend="${h.status == 'COMPLETED' ? 'badge bg-success' : (h.status == 'FAILED' ? 'badge bg-danger' : 'badge bg-warning text-dark')}"></span></td>
                <td th:text="${#temporals.format(h.startTime, 'MM-dd HH:mm:ss')}"></td>
                <td th:text="${#numbers.formatInteger(h.totalWrite, 0, 'COMMA')}"></td>
                <td th:text="${h.duration + '초'}"></td>
                <td>
                    <div th:if="${h.skipCount > 0}">
                        <a th:href="@{/admin/batch/error/list/{id}(id=${h.executionId})}"
                           class="btn btn-sm btn-danger py-0 fw-bold" style="font-size: 0.75rem;"
                           th:text="${h.skipCount + '건 (진단)'}"></a>
                    </div>
                    <span th:unless="${h.skipCount > 0}" class="text-muted small">0건</span>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<script th:inline="javascript">
    const eventSource = new EventSource('/admin/batch/realtime/stream');

    let targetProgress = 0;
    let displayProgress = 0;
    let interpolationTimer = null;
    let currentTps = 0;
    const TOTAL_COUNT = 1000000; // HTML에 표시된 100만건으로 동기화

    eventSource.addEventListener("batchUpdate", (event) => {
        const data = JSON.parse(event.data);
        const liveArea = document.getElementById('liveArea');
        const pb = document.getElementById('progressBar');
        const skipCard = document.getElementById('skipCard');

        // [3] 로딩 시 혹은 패킷 수신 시 실행 중인지 확인
        if (!data.isCompleted) {
            // 실행 중이면 컬러 모드로 전환
            liveArea.classList.remove('inactive-monitor');
            document.getElementById('statusDot').className = 'status-dot dot-online';
            document.getElementById('statusText').textContent = "정산 배치 가동 중...";
            document.getElementById('liveHeader').className = 'card-header bg-primary text-white py-3';

            // 데이터 수신 및 애니메이션 클래스 추가
            targetProgress = parseFloat((data.progress || "0%").replace('%', ''));
            currentTps = data.tps || 0;
            if (displayProgress === 0) displayProgress = targetProgress;

            // 지표 업데이트
            document.getElementById('processedCount').textContent = (data.totalProcessed || 0).toLocaleString();
            document.getElementById('tpsValue').textContent = (data.tps || 0).toLocaleString();
            document.getElementById('etcValue').textContent = data.etc || "00:00:00";
            document.getElementById('skipCount').textContent = (data.skipCount || 0).toLocaleString();

            // 에러 감지 및 바 상태 업데이트
            if (data.skipCount > 0) {
                pb.className = 'progress-bar bg-danger progress-bar-striped progress-bar-animated';
                skipCard.classList.add('clickable-error');
                skipCard.onclick = () => location.href = `/admin/batch/error/list/${data.currentJobId}`;
            } else {
                pb.className = 'progress-bar bg-success progress-bar-striped progress-bar-animated';
                skipCard.classList.remove('clickable-error');
            }

            // 파티션 그리드 업데이트
            if(data.partitions) {
                document.getElementById('partitionGrid').innerHTML = data.partitions.map(p => `
                    <div class="col-md-2 mb-2">
                        <div class="card p-2 border-0 shadow-sm small ${p.status === 'COMPLETED' ? 'bg-light' : 'bg-white'}">
                            <div class="fw-bold text-dark text-truncate">${p.stepName.split(':').pop()}</div>
                            <div class="${p.skipCount > 0 ? 'text-danger fw-bold' : 'text-primary fw-bold'}">${p.writeCount.toLocaleString()}</div>
                        </div>
                    </div>
                `).join('');
            }

            if (!interpolationTimer) startInterpolation();

        } else {
            // 배치가 실행 중이 아니면 회색 유지 및 감시 중단
            stopMonitoring("배치 종료");
        }
    });

    function startInterpolation() {
        interpolationTimer = setInterval(() => {
            const pb = document.getElementById('progressBar');
            const incrementalStep = Math.max((currentTps / TOTAL_COUNT) * 10, 0.001);

            if (displayProgress < targetProgress) {
                displayProgress += (targetProgress - displayProgress) * 0.05; // 널뛰기 방지 추격
            } else {
                displayProgress += incrementalStep;
            }

            if (displayProgress > 99.99 && targetProgress < 100) displayProgress = 99.99;

            const finalVal = displayProgress.toFixed(2);
            pb.style.width = finalVal + '%';
            pb.innerText = finalVal + '%';

            // [4] 100% 도달 시 애니메이션 제거
            if (displayProgress >= 100) {
                pb.classList.remove('progress-bar-striped', 'progress-bar-animated');
            }
        }, 100);
    }

    eventSource.addEventListener("finished", (event) => {
        targetProgress = 100;
        document.getElementById('statusText').textContent = "정산 완료";
        document.getElementById('statusDot').className = 'status-dot dot-success';

        // 애니메이션 즉시 제거
        const pb = document.getElementById('progressBar');
        pb.classList.remove('progress-bar-striped', 'progress-bar-animated');

        fetch('/admin/batch/dashboard/history-fragment')
            .then(res => res.text())
            .then(html => {
                document.getElementById('historyTableContainer').innerHTML = html;
            });
    });

    function stopMonitoring(msg) {
        if (interpolationTimer) clearInterval(interpolationTimer);
        interpolationTimer = null;
        eventSource.close();

        const liveArea = document.getElementById('liveArea');
        liveArea.classList.add('inactive-monitor');
        document.getElementById('statusDot').className = 'status-dot dot-offline';
        document.getElementById('statusText').textContent = msg;

        // 애니메이션 제거
        const pb = document.getElementById('progressBar');
        pb.classList.remove('progress-bar-striped', 'progress-bar-animated');
    }
</script>
</body>
</html>